# 21.2.3 监控InnoDB Cluster
本节描述如何使用AdminAPI监控InnoDB Cluster。

[Cluster.describe()](#clusterdescribe)

[Cluster.status()检查集群状态](#clusterstatus检查集群状态)

[监控恢复操作](#监控恢复操作)

[InnoDB Cluster和组复制协议](#InnoDB-Cluster和组复制协议)

[实例上检查MySQL版本](#实例上检查MySQL版本)

## Cluster.describe()

>To get information about the structure of the InnoDB Cluster itself, use the Cluster.describe() function:
```
mysql-js> cluster.describe();
{
    "clusterName": "testCluster",
    "defaultReplicaSet": {
        "name": "default",
        "topology": [
            {
                "address": "ic-1:3306",
                "label": "ic-1:3306",
                "role": "HA"
            },
            {
                "address": "ic-2:3306",
                "label": "ic-2:3306",
                "role": "HA"
            },
            {
                "address": "ic-3:3306",
                "label": "ic-3:3306",
                "role": "HA"
            }
        ]
    }
}
```
>The output from this function shows the structure of the InnoDB Cluster including all of its configuration information, and so on. The address, label and role values match those described at Checking a cluster's Status with Cluster.status() .

获取InnoDB Cluster本身结构的信息，可以使用`Cluster.describe()`。
```
mysql-js> cluster.describe();
{
    "clusterName": "testCluster",
    "defaultReplicaSet": {
        "name": "default",
        "topology": [
            {
                "address": "ic-1:3306",
                "label": "ic-1:3306",
                "role": "HA"
            },
            {
                "address": "ic-2:3306",
                "label": "ic-2:3306",
                "role": "HA"
            },
            {
                "address": "ic-3:3306",
                "label": "ic-3:3306",
                "role": "HA"
            }
        ]
    }
}
```
输出展示了InnoDB Cluster的结构，包括它的所有配置信息等。地址、标签和角色等与`Cluster.status()`一致。

## Cluster.status()检查集群状态

>Cluster objects provide the status() method that enables you to check how a cluster is running. Before you can check the status of the InnoDB Cluster, you need to get a reference to the InnoDB Cluster object by connecting to any of its instances. However, if you want to make changes to the configuration of the cluster, you must connect to a "R/W" instance. Issuing status() retrieves the status of the cluster based on the view of the cluster which the server instance you are connected to is aware of and outputs a status report.
>
>The instance's state in the cluster directly influences the information provided in the status report. Therefore ensure the instance you are connected to has a status of ONLINE.
>
>For information about how the InnoDB Cluster is running, use the cluster's status() method:
```
mysql-js> var cluster = dba.getCluster()
mysql-js> cluster.status()
{
    "clusterName": "testcluster", 
    "defaultReplicaSet": {
        "name": "default", 
        "primary": "ic-1:3306", 
        "ssl": "REQUIRED", 
        "status": "OK", 
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.", 
        "topology": {
            "ic-1:3306": {
                "address": "ic-1:3306", 
                "mode": "R/W", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }, 
            "ic-2:3306": {
                "address": "ic-2:3306", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }, 
            "ic-3:3306": {
                "address": "ic-3:3306", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }
        }
    }, 
    "groupInformationSourceMember": "mysql://icadmin@ic-1:3306"
}
```
>The output of `Cluster.status()` provides the following information:
>
>- clusterName: name assigned to this cluster during dba.createCluster().
>
>- defaultReplicaSet: the server instances which belong to an InnoDB Cluster and contain the data set.
>
>- primary: displayed when the cluster is operating in single-primary mode only. Shows the address of the current primary instance. If this field is not displayed, the cluster is operating in multi-primary mode.
>
>- ssl: whether secure connections are used by the cluster or not. Shows values of REQUIRED or DISABLED, depending on how the memberSslMode option was configured during either createCluster() or addInstance(). The value returned by this parameter corresponds to the value of the group_replication_ssl_mode server variable on the instance. See Securing your Cluster.
>
>- status: The status of this element of the cluster. For the overall cluster this describes the high availability provided by this cluster. The status is one of the following:
>
>   - ONLINE: The instance is online and participating in the cluster.
>
>   - OFFLINE: The instance has lost connection to the other instances.
>
>   - RECOVERING: The instance is attempting to synchronize with the cluster by retrieving transactions it needs before it can become an ONLINE member.
>
>   - UNREACHABLE: The instance has lost communication with the cluster.
>
>   - ERROR: The instance has encountered an error during the recovery phase or while applying a transaction.
>
>     Once an instance enters ERROR state, the super_read_only option is set to ON. To leave the ERROR state you must manually configure the instance with super_read_only=OFF.
>
>   - (MISSING): The state of an instance which is part of the configured cluster, but is currently unavailable.
>
>     The MISSING state is specific to InnoDB cluster, it is not a state generated by Group Replication. MySQL Shell uses this state to indicate instances that are registered in the metadata, but cannot be found in the live cluster view.
>
>- topology: The instances which have been added to the cluster.
>
>- Host name of instance: The host name of an instance, for example localhost:3310.
>
>- role: what function this instance provides in the cluster. Currently only HA, for high availability.
>
>- mode: whether the server is read-write ("R/W") or read-only ("R/O"). From version 8.0.17, this is derived from the current state of the super_read_only variable on the instance, and whether the cluster has quorum. In previous versions the value of mode was derived from whether the instance was serving as a primary or secondary instance. Usually if the instance is a primary, then the mode is "R/W", and if the instance is a secondary the mode is "R/O". Any instances in a cluster that have no visible quorum are marked as "R/O", regardless of the state of the super_read_only variable.
>
>- groupInformationSourceMember: the internal connection used to get information about the cluster, shown as a URI-like connection string. Usually the connection initially used to create the cluster.
>
>To display more information about the cluster use the extended option. From version 8.0.17, the extended option supports integer or Boolean values. To configure the additional information that Cluster.status({'extended':value}) provides, use the following values:
>
>- 0: disables the additional information, the default
>
>- 1: includes information about the Group Replication Protocol Version, Group name, cluster member UUIDs, cluster member roles and states as reported by Group Replication, and the list of fenced system variables
>
>- 2: includes information about transactions processed by connection and applier
>
>- 3: includes more detailed statistics about the replication performed by each cluster member.
>
>Setting extended using Boolean values is the equivalent of setting the integer values 0 and 1. In versions prior to 8.0.17, the extended option was only Boolean. Similarly prior versions used the queryMembers Boolean option to provide more information about the instances in the cluster, which is the equivalent of setting extended to 3. The queryMembers option is deprecated and scheduled to be removed in a future release.
>
>When you issue Cluster.status({'extended':1}), or the extended option is set to true, the output includes:
>
>- the following additional attributes for the defaultReplicaSet object:
>
>   - GRProtocolVersion is the Group Replication Protocol Version being used in the cluster.
>
>   - groupName is the group's name, a UUID.
>
>- the following additional attributes for each object of the topology object:
>
>   - fenceSysVars a list containing the name of the fenced system variables which are enabled. Currently the fenced system variables considered are read_only, super_read_only and offline_mode.
>
>   - memberId Each cluster member UUID.
>
>   - memberRole the Member Role as reported by the Group Replication plugin, see the MEMBER_ROLE column of the replication_group_members table.
>
>   - memberState the Member State as reported by the Group Replication plugin, see the MEMBER_STATE column of the replication_group_members table.
>
>To see information about recovery and regular transaction I/O, applier worker thread statistics and any lags; applier coordinator statistics, if parallel apply is enabled; error, and other information from I/O and applier threads issue use the values 2 and 3. A value of 3 is the equivalent of setting the deprecated queryMembers option to true. When you use these values, a connection to each instance in the cluster is opened so that additional instance specific statistics can be queried. The exact statistics that are included in the output depend on the state and configuration of the instance and the server version. This information matches that shown in the replication_group_member_stats table, see the descriptions of the matching columns for more information. Instances which are ONLINE have a transactions section included in the output. Instances which are RECOVERING have a recovery section included in the output. When you set extended to 2, in either case, these sections can contain the following:
>
>- appliedCount: see COUNT_TRANSACTIONS_REMOTE_APPLIED
>
>- checkedCount: see COUNT_TRANSACTIONS_CHECKED
>
>- committedAllMembers: see TRANSACTIONS_COMMITTED_ALL_MEMBERS
>
>- conflictsDetectedCount: see COUNT_CONFLICTS_DETECTED
>
>- inApplierQueueCount: see COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE
>
>- inQueueCount: see COUNT_TRANSACTIONS_IN_QUEUE
>
>- lastConflictFree: see LAST_CONFLICT_FREE_TRANSACTION
>
>- proposedCount: see COUNT_TRANSACTIONS_LOCAL_PROPOSED
>
>- rollbackCount: see COUNT_TRANSACTIONS_LOCAL_ROLLBACK
>
>When you set extended to 3, the connection section shows information from the replication_connection_status table. The connection section can contain the following:
>
>The currentlyQueueing section has information about the transactions currently queued:
>
>- immediateCommitTimestamp: see QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToNowTime: see QUEUEING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus NOW()
>
>- originalCommitTimestamp: see QUEUEING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToNowTime: see QUEUEING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus NOW()
>
>- startTimestamp: see QUEUEING_TRANSACTION_START_QUEUE_TIMESTAMP
>
>- transaction: see QUEUEING_TRANSACTION
>
>- lastHeartbeatTimestamp: see LAST_HEARTBEAT_TIMESTAMP
>
>The lastQueued section has information about the most recently queued transaction:
>
>- endTimestamp: see LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP
>
>- immediateCommitTimestamp: see LAST_QUEUED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToEndTime: LAST_QUEUED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus NOW()
>
>- originalCommitTimestamp: see LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToEndTime: LAST_QUEUED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus NOW()
>
>- queueTime: LAST_QUEUED_TRANSACTION_END_QUEUE_TIMESTAMP minus LAST_QUEUED_TRANSACTION_START_QUEUE_TIMESTAMP
>
>- startTimestamp: see LAST_QUEUED_TRANSACTION_START_QUEUE_TIMESTAMP
>
>- transaction: see LAST_QUEUED_TRANSACTION
>
>- receivedHeartbeats: see COUNT_RECEIVED_HEARTBEATS
>
>- receivedTransactionSet: see RECEIVED_TRANSACTION_SET
>
>- threadId: see THREAD_ID
>
>Instances which are using a multithreaded replica have a workers section which contains information about the worker threads, and matches the information shown by the replication_applier_status_by_worker table.
>
>The lastApplied section shows the following information about the last transaction applied by the worker:
>
>- applyTime: see LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP minus LAST_APPLIED_TRANSACTION_START_APPLY_TIMESTAMP
>
>- endTimestamp: see LAST_APPLIED_TRANSACTION_END_APPLY_TIMESTAMP
>
>- immediateCommitTimestamp: see LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToEndTime: see LAST_APPLIED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus NOW()
>
>- originalCommitTimestamp: see LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToEndTime: see LAST_APPLIED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus NOW()
>
>- startTimestamp: see LAST_APPLIED_TRANSACTION_START_APPLY_TIMESTAMP
>
>- transaction: see LAST_APPLIED_TRANSACTION
>
>The currentlyApplying section shows the following information about the transaction currently being applied by the worker:
>
>- immediateCommitTimestamp: see APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToNowTime: see APPLYING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus NOW()
>
>- originalCommitTimestamp: see APPLYING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToNowTime: see APPLYING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus NOW()
>
>- startTimestamp: see APPLYING_TRANSACTION_START_APPLY_TIMESTAMP
>
>- transaction: see APPLYING_TRANSACTION
>
>The lastProcessed section has the following information about the last transaction processed by the worker:
>
>- bufferTime: LAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP minus LAST_PROCESSED_TRANSACTION_START_BUFFER_TIMESTAMP
>
>- endTimestamp: see LAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP
>
>- immediateCommitTimestamp: see LAST_PROCESSED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToEndTime: LAST_PROCESSED_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus LAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP
>
>- originalCommitTimestamp: see LAST_PROCESSED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToEndTime: LAST_PROCESSED_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus LAST_PROCESSED_TRANSACTION_END_BUFFER_TIMESTAMP
>
>- startTimestamp: see LAST_PROCESSED_TRANSACTION_START_BUFFER_TIMESTAMP
>
>- transaction: see LAST_PROCESSED_TRANSACTION
>
>If parallel applier workers are enabled, then the number of objects in the workers array in transactions or recovery matches the number of configured workers and an additional coordinator object is included. The information shown matches the information in the replication_applier_status_by_coordinator table. The object can contain:
>
>The currentlyProcessing section has the following information about the transaction being processed by the worker:
>
>- immediateCommitTimestamp: see PROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP
>
>- immediateCommitToNowTime: PROCESSING_TRANSACTION_IMMEDIATE_COMMIT_TIMESTAMP minus NOW()
>
>- originalCommitTimestamp: see PROCESSING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP
>
>- originalCommitToNowTime: PROCESSING_TRANSACTION_ORIGINAL_COMMIT_TIMESTAMP minus NOW()
>
>- startTimestamp: see PROCESSING_TRANSACTION_START_BUFFER_TIMESTAMP
>
>- transaction: see PROCESSING_TRANSACTION
>
>worker objects have the following information if an error was detected in the replication_applier_status_by_worker table:
>
>- lastErrno: see LAST_ERROR_NUMBER
>
>- lastError: see LAST_ERROR_MESSAGE
>
>- lastErrorTimestamp: see LAST_ERROR_TIMESTAMP
>
>connection objects have the following information if an error was detected in the replication_connection_status table:
>
>- lastErrno: see LAST_ERROR_NUMBER
>
>- lastError: see LAST_ERROR_MESSAGE
>
>- lastErrorTimestamp: see LAST_ERROR_TIMESTAMP
>
>coordinator objects have the following information if an error was detected in the replication_applier_status_by_coordinator table:
>
>- lastErrno: see LAST_ERROR_NUMBER
>
>- lastError: see LAST_ERROR_MESSAGE
>
>- lastErrorTimestamp: see LAST_ERROR_TIMESTAMP




## InnoDB Cluster和组复制协议
